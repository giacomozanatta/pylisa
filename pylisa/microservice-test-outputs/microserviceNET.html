<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroserviceNet graph</title>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-graphviz/build/d3-graphviz.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        html,
        body {
          background-color: aliceblue;
        }

        .hovered {
          fill: #ffa500;
          stroke: #333;
          stroke-width: 2px;
          filter: drop-shadow(0 0 5px rgba(255, 153, 0, 0.5));
        }

        .node ellipse {
          transition: fill 0.3s ease, stroke 0.3s ease, stroke-width 0.3s ease;
        }

        .navbar {
          background-color: #d9ede0
        }
    </style>
</head>

<body>

<nav class="navbar">
    <div class="container-fluid ">
        <a class="navbar-brand" href="#">
            <img src="https://raw.githubusercontent.com/lisa-analyzer/lisa/master/logo.png" alt="Logo" height="50"
                 class="d-inline-block align-text-top">
        </a>

        <h4>Microservice Analyzer</h4>
    </div>
</nav>

<div class="d-flex flex-column min-vh-100">
    <div class="d-flex flex-grow-1 justify-content-center align-items-center" id="graph"></div>
</div>

<script>

    function addPathVariableInfo(jsonData) {
      let pathVariables = '';
      jsonData.forEach(param => {
        pathVariables +=
          `<hr>
            <p><strong>Variable:</strong> ${param.name}</p>
              <ul class="list-group">
                <li class="list-group-item list-group-item-action list-group-item-light"> Type: ${param.typeCustomDefinition ? 'Custom': param.type} </li>
              </ul>`;
      });
      return pathVariables;
    }

    function addIssues(jsonData) {
      let issues = '';
      jsonData.forEach(issue => {
        issues +=
          `<hr>
              <ul class="list-group">
                  <li class="list-group-item list-group-item-danger">${issue}</li>
              </ul>`;
      });
      return issues;
    }

    const graphviz = d3.select("#graph").graphviz()
      .fit(true)
      .zoom(true)
      .addImage("\/Users\/teodors\/Documents\/erasmus\/lisa\/projects\/lisa-on-microservices\/pylisa\/pylisa\/src\/main\/resources\/assets\/cross-mark.png", "40px", "40px")
      .height(1200);

    /*<![CDATA[*/
    const dot = "digraph \"microservice_graph\" {\ngraph [\"splines\"=\"ortho\",\"bgcolor\"=\"white:white\",\"gradientangle\"=\"90\"]\nsubgraph \"cluster_microservice_b\" {\ngraph [\"rankdir\"=\"LR\",\"style\"=\"rounded\",\"color\"=\"black\",\"label\"=\"microservice_b\",\"fontname\"=\"Helvetica-bold\",\"fontsize\"=\"24\",\"splines\"=\"ortho\",\"bgcolor\"=\"grey80:#93c383\",\"gradientangle\"=\"90\"]\n\"PUT \/manufacturer\/{id}\" [\"label\"=<<b>PUT<\/b><br\/>\/manufacturer\/{id}>,\"color\"=\"lightblue\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"PUT\\\",\\\"fullPath\\\":\\\"\/manufacturer\/{id}\\\",\\\"pathVariableName\\\":\\\"id\\\",\\\"belongs\\\":\\\"microservice_b\\\",\\\"codeLocation\\\":\\\"microservice_b.py':6:16\\\",\\\"issues\\\":[\\\"Endpoint does not accept any arguments to specify the object to update.\\\"],\\\"methodPathVariable\\\":[{\\\"type\\\":\\\"string\\\",\\\"name\\\":\\\"id\\\",\\\"typeCustomDefinition\\\":false},{\\\"type\\\":\\\"numeric\\\",\\\"name\\\":\\\"name\\\",\\\"typeCustomDefinition\\\":false}],\\\"role\\\":\\\"PROVIDER\\\"}\"]\n\"POST \/quota\/fik39\" [\"label\"=<<b>POST<\/b><br\/>\/quota\/fik39>,\"color\"=\"red3\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"fontcolor\"=\"white\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"POST\\\",\\\"fullPath\\\":\\\"\/quota\/fik39\\\",\\\"pathVariableName\\\":null,\\\"belongs\\\":\\\"microservice_b\\\",\\\"codeLocation\\\":\\\"microservice_b.py':14:29\\\",\\\"issues\\\":[],\\\"methodPathVariable\\\":[],\\\"role\\\":\\\"CONSUMER\\\"}\"]\n\"GET \/report\/3\" [\"label\"=<<b>GET<\/b><br\/>\/report\/3>,\"color\"=\"red3\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"fontcolor\"=\"white\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"GET\\\",\\\"fullPath\\\":\\\"\/report\/3\\\",\\\"pathVariableName\\\":null,\\\"belongs\\\":\\\"microservice_b\\\",\\\"codeLocation\\\":\\\"microservice_b.py':11:28\\\",\\\"issues\\\":[],\\\"methodPathVariable\\\":[],\\\"role\\\":\\\"CONSUMER\\\"}\"]\n}\nsubgraph \"cluster_microservice_c\" {\ngraph [\"rankdir\"=\"LR\",\"style\"=\"rounded\",\"color\"=\"black\",\"label\"=\"microservice_c\",\"fontname\"=\"Helvetica-bold\",\"fontsize\"=\"24\",\"splines\"=\"ortho\",\"bgcolor\"=\"grey80:#9b9cd2\",\"gradientangle\"=\"90\"]\n\"POST \/quota\/{name}\" [\"label\"=<<b>POST<\/b><br\/>\/quota\/{name}>,\"color\"=\"lightblue\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"POST\\\",\\\"fullPath\\\":\\\"\/quota\/{name}\\\",\\\"pathVariableName\\\":\\\"name\\\",\\\"belongs\\\":\\\"microservice_c\\\",\\\"codeLocation\\\":\\\"microservice_c.py':6:17\\\",\\\"issues\\\":[\\\"Endpoint does not accept any argument of custom definition, t.i. model. Only primitives.\\\"],\\\"methodPathVariable\\\":[{\\\"type\\\":\\\"string\\\",\\\"name\\\":\\\"id\\\",\\\"typeCustomDefinition\\\":false}],\\\"role\\\":\\\"PROVIDER\\\"}\"]\n\"GET \/report\/1\" [\"label\"=<<b>GET<\/b><br\/>\/report\/1>,\"color\"=\"red3\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"fontcolor\"=\"white\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"GET\\\",\\\"fullPath\\\":\\\"\/report\/1\\\",\\\"pathVariableName\\\":null,\\\"belongs\\\":\\\"microservice_c\\\",\\\"codeLocation\\\":\\\"microservice_c.py':11:28\\\",\\\"issues\\\":[],\\\"methodPathVariable\\\":[],\\\"role\\\":\\\"CONSUMER\\\"}\"]\n\"PUT \/manufacturer\/ChanVendor\" [\"label\"=<<b>PUT<\/b><br\/>\/manufacturer\/ChanVendor>,\"color\"=\"red3\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"fontcolor\"=\"white\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"PUT\\\",\\\"fullPath\\\":\\\"\/manufacturer\/ChanVendor\\\",\\\"pathVariableName\\\":null,\\\"belongs\\\":\\\"microservice_c\\\",\\\"codeLocation\\\":\\\"microservice_c.py':14:28\\\",\\\"issues\\\":[],\\\"methodPathVariable\\\":[],\\\"role\\\":\\\"CONSUMER\\\"}\"]\n}\nsubgraph \"cluster_microservice_a\" {\ngraph [\"rankdir\"=\"LR\",\"style\"=\"rounded\",\"color\"=\"black\",\"label\"=\"microservice_a\",\"fontname\"=\"Helvetica-bold\",\"fontsize\"=\"24\",\"splines\"=\"ortho\",\"bgcolor\"=\"grey80:#addb94\",\"gradientangle\"=\"90\"]\n\"GET \/report\/{pageNr}\" [\"label\"=<<b>GET<\/b><br\/>\/report\/{pageNr}>,\"color\"=\"lightblue\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"GET\\\",\\\"fullPath\\\":\\\"\/report\/{pageNr}\\\",\\\"pathVariableName\\\":\\\"pageNr\\\",\\\"belongs\\\":\\\"microservice_a\\\",\\\"codeLocation\\\":\\\"microservice_a.py':7:16\\\",\\\"issues\\\":[\\\"Endpoint's path method accepts non-string or non-numeric parameter.\\\"],\\\"methodPathVariable\\\":[{\\\"type\\\":\\\"boolean\\\",\\\"name\\\":\\\"pageNr\\\",\\\"typeCustomDefinition\\\":false}],\\\"role\\\":\\\"PROVIDER\\\"}\"]\n\"DELETE \/item\/{item_id}\" [\"label\"=<<b>DELETE<\/b><br\/>\/item\/{item_id}>,\"color\"=\"lightblue\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"DELETE\\\",\\\"fullPath\\\":\\\"\/item\/{item_id}\\\",\\\"pathVariableName\\\":\\\"item_id\\\",\\\"belongs\\\":\\\"microservice_a\\\",\\\"codeLocation\\\":\\\"microservice_a.py':15:19\\\",\\\"issues\\\":[\\\"Endpoint deletes entity without prior check-up for its existence.\\\"],\\\"methodPathVariable\\\":[{\\\"type\\\":\\\"string\\\",\\\"name\\\":\\\"item_id\\\",\\\"typeCustomDefinition\\\":false}],\\\"role\\\":\\\"PROVIDER\\\"}\"]\n\"GET\" [\"label\"=<<b>GET<\/b><br\/>This endpoint was left without path definition>,\"fillcolor\"=\"lightgray\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"style\"=\"dotted\"]\n\"POST \/quota\/nau16\" [\"label\"=<<b>POST<\/b><br\/>\/quota\/nau16>,\"color\"=\"red3\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"fontcolor\"=\"white\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"POST\\\",\\\"fullPath\\\":\\\"\/quota\/nau16\\\",\\\"pathVariableName\\\":null,\\\"belongs\\\":\\\"microservice_a\\\",\\\"codeLocation\\\":\\\"microservice_a.py':25:29\\\",\\\"issues\\\":[],\\\"methodPathVariable\\\":[],\\\"role\\\":\\\"CONSUMER\\\"}\"]\n\"PUT \/manufacturer\/JoeVendor\" [\"label\"=<<b>PUT<\/b><br\/>\/manufacturer\/JoeVendor>,\"color\"=\"red3\",\"fontname\"=\"Helvetica\",\"fontsize\"=\"14\",\"fontcolor\"=\"white\",\"style\"=\"filled\",\"tooltip\"=\"{\\\"method\\\":\\\"PUT\\\",\\\"fullPath\\\":\\\"\/manufacturer\/JoeVendor\\\",\\\"pathVariableName\\\":null,\\\"belongs\\\":\\\"microservice_a\\\",\\\"codeLocation\\\":\\\"microservice_a.py':22:28\\\",\\\"issues\\\":[],\\\"methodPathVariable\\\":[],\\\"role\\\":\\\"CONSUMER\\\"}\"]\n}\n\"GET \/report\/3\" -> \"GET \/report\/{pageNr}\"\n\"GET \/report\/1\" -> \"GET \/report\/{pageNr}\"\n\"PUT \/manufacturer\/JoeVendor\" -> \"PUT \/manufacturer\/{id}\"\n\"PUT \/manufacturer\/ChanVendor\" -> \"PUT \/manufacturer\/{id}\"\n\"POST \/quota\/nau16\" -> \"POST \/quota\/{name}\"\n\"POST \/quota\/fik39\" -> \"POST \/quota\/{name}\"\n}";
    /*]]>*/

    function renderGraph(dotString) {
      graphviz.renderDot(dotString, function () {
        d3.selectAll(".node")
          .on("mouseover", function () {
            d3.select(this)
              .select("ellipse")
              .classed("hovered", true);
          })
          .on("mouseout", function () {
            d3.select(this)
              .select("ellipse")
              .classed("hovered", false);
          });
      }).on("end", function () {
        d3.selectAll(".node a").each(function () {

          const node = d3.select(this);
          var info = d3.select(this).attr("xlink:title");

          const jsonData = JSON.parse(info);
          console.log(jsonData);

          new bootstrap.Popover(this, {
            container: 'body',
            html: true,
            trigger: 'hover',
            placement: 'top',
            title: jsonData.fullPath || "Default Title",
            content: function () {
              return `<h6>${jsonData.role}</h6>
                        <strong>Method:</strong> ${jsonData.method}<br>
                        <strong>Endpoint:</strong> ${jsonData.fullPath}<br>
                        <strong>Path variable:</strong> ${jsonData.pathVariableName}<br>
                        <strong>Location:</strong> ${jsonData.codeLocation}<br>
                        ${addPathVariableInfo(jsonData.methodPathVariable)}
                        ${addIssues(jsonData.issues)}`;
            }
          });
        });
      });
    }

    renderGraph(dot);

</script>
</body>

</html>